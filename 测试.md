### 一、性能测试基础	

#### 1.1、性能测试概述

- ##### 评估系统能力，关注时间和资源

- ##### 评估系统能力、寻找性能瓶颈、预测未来性能

  注意事项：
  	a、尽早进行测试，越早越能够发现问题
  	b、性能测试需要团队支持，性能优化需要开发、运维部门相关部门支持
  	c、测试需要独立的测试环境，测试需要独立的网络和硬件环境，保证被测系统是独立可控的，甚至需要专门的管理员和流程对测试环境进行控制
  	d、测试前确定的测试目标，测试脚本执行成本较高，为保证测试执行有效性，在测试前确定测试目标

#### 1.2、性能测试分类

##### 1.2.1、基准测试

​	a、模拟单一用户请求一种或者多种业务，产出基准性能数据

​	b、为多用户并发测试和综合场景测试等性能分析提供参考依据

##### 1.2.2、并发测试

- ​	通过模拟用户并发访问，测试多用户同时访问同一应用、模块或数据，观察系统是否存在问题

##### 1.2.3、负载测试

- 对被测系统不断加压，直到超过预定的指标或者资源达到了饱和状态不能加压为止

##### 1.2.4、压力测试

- 系统已经达到一定饱和状态，例如CPU、磁盘等处于饱和状态，此时系统能够处理业务的能力，系统是否会出现出错

##### 1.2.5、稳定性测试

- 又称可靠性测试，在系统加载一定业务压力的情况下，使系统运行一段时间7*24th，以此检测系统是否稳定

##### 1.2.6 配置测试

- 配置测试通过对被测系统的软硬件环境的调整，了解不同配置对系统的性能影响的程度，从而找到系统各项资源的最优配置

#### 1.3 性能测试的指标

##### 1.3.1 系统指标

- 响应时间

  定义：从用户发送一个请求到用户接收到服务器返回的响应数据这段时间就是响应时间

##### 1.3.2 并发数

- 并发用户数

  某物理时刻同时向系统提交请求的用户数

- 在线用户数

  某段时间内访问系统的用户数，这些用户并不一定同时向系统提交请求

- 系统用户数

  系统注册用户总数

- 三者之间联系

  系统用户数>=在线用户数>=并发用户数

##### 1.3.3 TSP

- 定义

  Transactions Per Second，意思是每秒事务数，单位时间内系统处理的客户端请求的事物次数，每个事物包含3个过程：

  a、向服务器发请求

  b、服务器处理请求

  c、服务器返回结果给客户端

- 计算方法

  tsp= 并发数/平均响应时间

##### 1.3.4 资源利用率

- 定义

  对不同系统资源的使用程度，通常以占用最大的百分比来衡量

- 服务器资源指标

  - CPU使用率

    长时间情况下，一般可接受上限85%

  - 内存利用率

    一般至少10%可用内存，内存使用率可接受上限85%

  - 磁盘IO

    一般使用%Disk Time（磁盘用于读写操作所占用的时间百分比）度量磁盘读写性能

  - 网络带宽

    判断网络连接速度是否达到瓶颈，可以用改计数器的值和目前网络带宽比较，8b=1B，100Mbps=12.5M

### 二、性能测试流程

```tiki wiki
需求分析 -> 测试计划方案 -> 测试执行 -> 结果分析
```

#### 2.1 性能需求分析

```java
性能需求分析是性能测试的基础，需求分析做的好不好直接影响性能测试的结果
```

- 明确被测系统

  - 系统架构

  - 系统要求

    - 开发语言
    - 运行环境
  
- 明确性能测试内容
  
  ```java
  电商业务 注册与登录、商品详情、搜索、支付等
  ```

- 明确性能测试策略
  
  - 基准测试
  - 压力测试
  - 负载测试
  - 稳定性测试

- 明确性能测试的指标

  - **无明确需求指标**
  
    1. 需要自己挖掘或者团队一起分析
    2. 只能靠自己查找相关资料，和类似的系统对比，以及对未来流量的预估，确定性能测试需求的指标
  
  - **明确需求指标**
  
    例如：类似指标
  
    1. 对某业务并发20个用户
    2. 平均响应时间小于等于3s
    3. 事务成功率为100%
    4. CPU使用率小于等于85%
  
    只需要根据执行分析结果与预期指标对比，如果有不满足的，就需要分析问题所在
  
  - **确定性能指标**
  
    - 响应时间
  
    - 并发数
  
    - TPS
  
      1. 根据28定律：80%的用户请求，集中在20%的热点数据或者时间段
  
         案例1：客单价200-500，以300计算，某电商要求每天完成交易额2亿
  
         **分析**：
  
         - 采用28定律，以24小时计算
  
         - 每天交易数 = 1亿 / 300
  
         - 每小时交易数 = 每天交易数 * 0.8 / (24 * 0.2)  = 111111.1111  
  
           注释：80%的请求集中在20%的热点时间段上
  
         **结果**：
  
         - TPS = 111111 / 3600 秒 = 30.86
  
      2. 资源利用率
  
         软件检测工具
  
 #### 2.2 性能测试计划及方案

目标：了解性能测试计划和方案的编写

##### 2.2.1 测试计划

- 测试目标

  确定此次性能测试的目的

  - 登录
  - 支付

- 人类资源

  - 明确性能测试的时间，计划需要多少人进行测试

- 时间进度

  | 性能测试       | 工作日 | 开始时间 | 结束时间 |
  | -------------- | ------ | -------- | -------- |
  | 测试用例设计   |        |          |          |
  | 测试环境搭建   |        |          |          |
  | 测试数据准备   |        |          |          |
  | 脚本开发及执行 |        |          |          |
  | 测试结果分析   |        |          |          |

- 风险

  - 列出可能出现的问题

##### 2.2.2 测试方案

- 测试环境

  - 架构设计

  - 软硬件配置

    注意：尽量和生产环境一致

    - 服务器
    - 数据库

  - 性能测试工具

    - LoadRounner
    - Jmeter

  - 监控工具

    - Linux
      - nmon	分析Linux性能的免费工具
      - rpc   安装在LInux，结合loadrunner使用
      - jvisualVm  主要监控java程序，监控内存等
      - Spotlight  监控数据库相关的信息
    - Windows
      - Spotlight  监控数据库相关的信息
      - perfmon.exe  性能监视器，windows自带的监控工具
  
- 测试策略

  满足在规定的服务器资源性能指标范围内，模拟不同用户数量的性能测试，确定系统能够承受的最大并发数。

  - 一般的性能测试
    - 单一场景
      - 登录
      - 下单
    - 混合场景
      - 登录->查看商品->下单
  - 稳定性测试
    - 混合业务场景下，在负载测试的并发数下，延长测试时常到3*24小时，考察系统的稳定性

#### 2.3 性能测试用例设计及执行

目标：了解性能测试用例的设计与执行

##### 2.3.1 性能测试用例设计

**按照场景设计分类**

- 预期性能测试的指标
- 单业务并发性能的测试
- 混合场景并发性能测试

**测试用例设计**

- 测试性能点

  - 登录
  - 注册

- 用例的编写

  - 预期性能指标用例

    | 用例编号 | 用例目的                                    | 测试数据 |
    | -------- | ------------------------------------------- | -------- |
    | 登录-001 | 测试100个虚拟用户并发时，系统登录的响应时间 | 3000     |

    | 操作步骤            | 期望的性能 |
    | ------------------- | ---------- |
    | 1、打开浏览器       |            |
    | 2、输入网址         |            |
    | 3、输入用户名、密码 | <1s        |
    | 4、点击login登录    |            |
    | 5、点击sign off退出 |            |
    | 6、关闭浏览器       |            |

  - 单业务并发性能测试

    | 功能 |            登录系统            |
    | ---- | :----------------------------: |
    | 目的 | 测试多人同时登录系统的性能情况 |
    | 方法 |                                |

    并发数与事务执行情况

    | 并发数 | 事务平均响应时间 | 事务最大响应时间 | 平均每秒处理事务数 | 事务成功率 |
    | ------ | ---------------- | ---------------- | ------------------ | ---------- |
    | 20     |                  |                  |                    |            |
    | 30     |                  |                  |                    |            |
    | 40     |                  |                  |                    |            |
    | 50     |                  |                  |                    |            |
    | 100    |                  |                  |                    |            |

  - 混合场景并发性能测试

    | 功能 | 100人同时操作:5人注册，30人登录，50人订票，15人取消订单 |
    | ---- | :-----------------------------------------------------: |
    | 目的 |         测试100人同时对系统操作，系统的性能情况         |

    并发数与事务执行情况

    | 并发数                                    | 事务平均响应时间 | 事务最大响应时间 | 平均每秒处理事务 | 事务成功率 |
    | ----------------------------------------- | ---------------- | ---------------- | ---------------- | ---------- |
    | 5人注册，30人登录，50人订票，15人取消订单 |                  |                  |                  |            |

    登录、注册、订票、取消订单 整合到表格中每个空格

#####  2.3.2 性能测试用例执行

- 脚本编写

  根据测试用例设计编写对应的脚本

- 场景监控设计

  把编写好的脚本去设计执行

- 运行场景

- 监控场景

- 测试报告

  - 压测结果  通过表格方式描述结果是否满足要求

  - 监控图

    包括性能指标的结果及图形

    - TPS
    - 响应时间

  - 性能评估

    根据结果进行性能分析及评估，提供可优化的方案

### 三、LoadRunner工具的使用

目标：LoadRunner环境搭建及功能介绍

#### 3.1 LoadRunner的安装和破解

目标：安装LoadRunner

##### 3.1.1 LoadRunner基本组成

```java
LoadRunner有4部分组成：Virtual user generator、Controller、Load Generator、Analysis
```

- 用户脚本（Virtual user generator）
  - 简称VuGen
  - 录制与编写脚本的地方，通过录制或者编写脚本模拟用户的行为也可以理解为用户行为的编辑器，同时会打印出日志信息，方便调试脚本
  - 它是个集成开发调试环境，在这里完成脚本开发并调试通过后可以放到Controller中创建场景
- 控制台（Controller）
  - 性能测试场景设计以及监控的地方，设计场景
  - Controller本身无法形成负载，它只是一个设计工具
- 压力生产器（Load Generator）
  - 负责将VuGen脚本复制成大量虚拟用户对系统产生负载
  - 由于生成的负载一般数量较大，通过一台Controller调用多台Load Generator
- 结果分析器（Analysis）
  - 收集测试数据后生成图表报告的地方，帮助我们分析数据并产生图片，方便对负载生成后的相关数据进行整理分析

##### 3.2.1 LoadRunner自带测试环境

- 启动系统自带的程序：

  ```java
  开始->HP LOadRunner->Samples->Web, 点击Start Web Server, 启动服务
  loadrunner12版本去除了Web Tours功能，需要自行安装：
  https://blog.csdn.net/kongsuhongbaby/article/details/84899785
  1、点击WebTours目录下StartServer.bat
  2、启动浏览器输入:http://127.0.0.1:1080/WebTours/
  3、用户名:jojo 密码:bean
  ```


#### 3.2 LoadRunner脚本录制

##### 3.2.1 Virtual User Generator介绍

```java
1、Virtual User Generator是一种基于录制回放的工具，可以把操作的步骤录制下来，自动转化为脚本
2、在Vugen中录制的用户行为就是虚拟了一个用户的行为，称之为Vuesr，脚本称为Vuser Script
3、Vugen进行用户行为模拟的流程    
```

##### 3.2.2 脚本录制

- 协议探测器

    目标：了解协议探测器的使用

  - 协议选择的重要性

    ```java
    录制脚本前，选择正确的协议很关键，错误的协议会导致Vegen录制不到脚本，或者录制脚本不完整，有些应用可能需要选择多个协议才能完整的记录 客户端与服务器端的请求		
    ```

  - 如何选择协议

    - 咨询开发人员
    - 根据经验判断
    - 自带的协议探测工具

  - 协议探测器使用

    - 启动系统自带程序	`HP Web Tours Application`

    - 启动LoadRunner协议探测器

      ```
      操作步骤：
      复制程序路径，程序分析
      ```

- 录制脚本操作

  目标：了解录制脚本操作

  案例：实现自带web系统功能：登录-退出操作

  - 录制前准备

    - 启动测试环境	`启动loadrunner自带测试程序web tour`
    - 确定被测系统类型   `Web(HTTP/HTML)`
    - 录制采用浏览器   `IE如果64位，选择X86下的ie浏览器`
    - 被测服务器地址   `http://127.0.0.1:1080/WebTours/`

  - 录制脚本

    - 新建脚本--选择网络协议  `启动loadrunner，选择网络协议Web(HTTP/HTML)`

    - 设置录制选项  `点击录制，选择类型internet`

    - 开始录制

      - 点击ok，开始录制
      - LoadRunner自动打开浏览器 `http://127.0.0.1:1080/WebTours/`
      - 登录信息： `用户名/密码 jojo/bean`

    - 停止录制

      - 点击停止录制
      
      - 脚本生成
      
    - 查看脚本
      
      - Script
      - Tree
  
 - 录制设置
   
   目标：了解录制配置中Recoding的具体用法
   
   - 打开方式  `录制选项 ctrl+F7  `
   
   - 录制模式
   
     - 基于HTML方式
   
       ```java
       对每个页面录制形成一条语句
       ```
   
     - 基于URL方式
   
       ```java
       将每条客户端发起的请求露珠成一条语句
       该模式下，一条语句只能建立一个到服务器的连接，并将通信过程中的很多隐藏的信息都录制下来
       ```
   
     - 两种方式对比
   
       ```java
       基于html的脚本：
           html录制级别会位每一个html用户动作产生一个单独的步骤，而且html方式产生的脚本非常简洁和直观，易于阅读。
   基于URL的脚本：
           URL录制级别把对服务器每个对象的请求，都录制成一个单独的请求，对业务过程有更好的控制。
       ```
     ```
       
     - 如何选择两种模式
     
       ```java
       1、基于浏览器的应用程序推荐使用html的脚本
       2、不是基于浏览器的应用程序推荐使用URL的脚本
       3、基于浏览器的应用程序中使用了HTTPS安全协议，使用URL方式录制	
     ```
     
     - 注意事项
     
       ```java
       1、脚本录制过程灵活切换html和url级别以获得最佳效果
       2、解决录制过程中乱码：HTTP ... Charset:UTF-8
       ```

##### 3.3.2 脚本的组成及函数 


   目标：了解VuGen脚本组成及函数使用

- VuGen脚本组成

  ```java
  vuser_init: 虚拟用户初始化、运行一次
  action:	具体操作
  vuser_end: 结束操作，运行一次
  注意: 迭代脚本时，vuser_init和vuser_end只会执行一次，迭代的是action的内容
  ```

- 函数

  ```java
  脚本模式下，每个脚本都是函数，函数中的参数记录了客户端发送给服务器(请求request)的数据	
  ```

  - web_url

    直接请求了一个网页

    ```java
    web_url("WebTours", 								步骤名称
    	"URL=http://127.0.0.1:1080/WebTours/", 			请求地址
    	"TargetFrame=", 	
    	"Resource=0", 
    	"RecContentType=text/html", 					内容类型
    	"Referer=", 
    	"Snapshot=t31.inf", 							页面快照名称
    	"Mode=HTML", 									结束符
    	LAST);
    ```

  - web_submit_data

    用来生成表单的GET或者POST请求

    ```java
    web_submit_data("login.pl", 								步骤名称
    	"Action=http://127.0.0.1:1080/cgi-bin/login.pl", 		提交地址
    	"Method=POST", 											请求方式
    	"TargetFrame=body", 
    	"RecContentType=text/html", 
    	"Referer=http://127.0.0.1:1080/cgi-bin/nav.pl?in=home", 页面地址
    	"Snapshot=t32.inf", 									页面快照名称
    	"Mode=HTML", 											录制模式		
    	ITEMDATA, 												提交内容	
    	"Name=userSession", "Value=134671.252652896zQcHVfcpffiDDDDDtVfzcpQVfDf", ENDITEM, 
    	"Name=username", "Value=jojo", ENDITEM, 
    	"Name=password", "Value=bean", ENDITEM, 
    	"Name=JSFormSubmit", "Value=off", ENDITEM, 
    	"Name=login.x", "Value=36", ENDITEM, 
    	"Name=login.y", "Value=1", ENDITEM, 
    	LAST);
    ```

  - web_image

    通过单击图片链接请求打开一个网页

    ```java
    web_url("SignOff Button", 
    	"URL=http://127.0.0.1:1080/cgi-bin/welcome.pl?signOff=1", 
    	"TargetFrame=body", 
    	"Resource=0", 
    	"RecContentType=text/html", 
    	"Referer=http://127.0.0.1:1080/cgi-bin/nav.pl?page=menu&in=home", 
    	"Snapshot=t33.inf", 
    	"Mode=HTML", 
    	LAST);
    ```

##### 3.3.3 脚本回放流程

目标：了解脚本回放和查看结果

- 脚本运行

  - 点击run或者F5      

  - 查看结果

    包含录制、会话、关联等相关信息的输出管理

    LR包含4类日志文件

    - Replay Log 回放日志

      ```java
      脚本回放时lr记录的日志信息，包含客户端与服务器之间的通信日志和html源码录制时的快照信息，但该日志信息的内容取决于log选项卡中extended log选项的设置情况
      ```

    - Recoding Log 录制日志

      ```java
      录制脚本时产生的日志，只要时客户端和服务器端通信时的一些交互信息
      ```

    - Correlation Results 关联结果

      ```java
      当脚本需要关联时，回放脚本过程中记录录制和回放时需要关联内容的信息
      ```

    - Generation Log 生成日志

      ```
      脚本生成的日志信息
      ```

- 运行设置

  ```java
  回放 - 运行时设置(F4)
  ```
  
  - run logic 运行逻辑
  
    ```java
    用于设置运行时脚本的迭代次数
    init和end只执行一次，run执行迭代次数
    ```
  
  - pacing 节奏
  
    ```java
    配置脚本运行中每次迭代之间的等待时间，如果需要周期性在脚本中重复做某些事情，可以通过pacing来实现
    1、默认设置上一次迭代一结束就开始下一次迭代，无等待时间
    2、上次迭代结束后需要等待一段时间后进行下一次迭代 （迭代先后执行）
        fixed 延迟固定的时间开始新的迭代
        random 延迟随机的时间段开始新的迭代
    3、前一个脚本的启动到下一个脚本启动之间的时间   
        下个迭代延迟到达延迟时间后立即执行，延迟时间过短可能上次迭代还未执行完报警告
    ```
  
  - log 日志
  
    ```java
    设置脚本回放时的日志格式，提供了一定的调试分析基础，脚本回放验证可以依靠日志来实现
    extend log 扩展日志
    	- parameter substitution 参数替换
          将参数赋值操作作为日志输出，输出内容为蓝色
        - data returned by server 服务器返回的数据
          表示不仅包含参数替代的信息，还包括服务器返回到客户端的信息也会被记录
        - advanced trace 高级跟踪
          高级跟踪日志，所有虚拟用户信息和函数调用输出到日志文件中	
    ```
    
  - think time 用户思考时间
  
    ```java
    用于设置用户操作的思考时间（每个http请求之间的时间间隔）
    ignore think time 
        运行脚本时忽略思考时间，上一个http请求结束后，直接运行下一个http请求，不等待
    replay think time 设置思考时间
        - as record
        
    ```
  
    
  
  
  
  
  
  
  







































